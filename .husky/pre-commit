#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "üîç Running pre-commit checks..."

# Run linter
echo "üìù Linting code..."
npm run lint || {
  echo "‚ùå Linting failed. Please fix errors before committing."
  exit 1
}

# Run prettier
echo "üé® Checking code formatting..."
npx prettier --check "**/*.{js,jsx,ts,tsx,json,css,md}" || {
  echo "‚ùå Code formatting check failed. Run 'npm run format' to fix."
  exit 1
}

# Run tests
echo "üß™ Running tests..."
npm test -- --bail --findRelatedTests || {
  echo "‚ùå Tests failed. Please fix before committing."
  exit 1
}

# Check for sensitive data
echo "üîí Checking for sensitive data..."
if git diff --cached | grep -qE '(password|secret|api[_-]?key|token|credentials).*=.*["\x27][^"\x27]{8,}'; then
  echo "‚ö†Ô∏è  WARNING: Potential sensitive data detected in commit!"
  echo "Please review your changes and remove any secrets."
  echo "Use environment variables instead."
  exit 1
fi

# Check for console.log
echo "üö´ Checking for console.log..."
if git diff --cached --name-only | grep -E '\.(js|jsx|ts|tsx)$' | xargs grep -n 'console\.log' 2>/dev/null; then
  echo "‚ö†Ô∏è  WARNING: console.log statements found!"
  echo "Please remove or replace with proper logging before committing."
  echo "Use logger.info(), logger.debug(), etc. instead."
  # Don't fail, just warn
fi

echo "‚úÖ Pre-commit checks passed!"
